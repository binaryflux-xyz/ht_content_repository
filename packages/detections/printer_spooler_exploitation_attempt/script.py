# Detection: Printer Spooler Exploitation Attempt
# Purpose: Detect DLL injection into spoolsv.exe or abnormal child process spawn by spoolsv.exe (PrintNightmare patterns)
# Events considered: Sysmon ProcessCreate (1) and ImageLoaded (7) / security process creation logs
# Condition: DLL loaded into spoolsv.exe OR spoolsv.exe spawns an unusual child (cmd/powershell/rundll32/etc.)
# MITRE: Exploitation for Privilege Escalation (T1068) / Privilege Escalation (TA0004)

def window():
    return '1m'   # immediate detection window (single event typically sufficient)

def groupby():
    # scope by host and process to correlate related events
    return ['host', 'process_name']
def investigate():
    return "windows_server_session_analyser"

def automate():
    return False
def algorithm(event):
    """
    Detects:
      - Image load events where target process is spoolsv.exe and a DLL was loaded
      - Process create events where ParentImage or ParentProcessName is spoolsv.exe and the child is suspicious
    """

    evt =event.get('event_id') 

    # normalize host and process fields
    host = event.get('host')
    if host:
        host = host.lower()
    
    process_name = event.get('process_name')
    if process_name:
        process_name = process_name.lower()
    
    parent_image = event.get('parent_image') or event.get('parent_process') or event.get('parent_image_name')
    if parent_image:
        parent_image = parent_image.lower()
    
    image = event.get('image') or event.get('process_path') or event.get('target_image')
    if image:
        image = image.lower()
    
    loaded_module = event.get('loaded_module') or event.get('loaded_image') or event.get('module')
    if loaded_module:
        loaded_module = loaded_module.lower()

    # canonical spooler process name
    spool_event = False
    if (process_name and 'spoolsv.exe' in process_name) or \
       (parent_image and 'spoolsv.exe' in parent_image) or \
       (image and 'spoolsv.exe' in image):
        spool_event = True

    # 1) DLL load into spoolsv.exe (Sysmon Image Loaded events often use event_id 7 or similar)
    # Detect if target process is spoolsv.exe and a .dll was loaded
    if evt in [7, 11, 6, 10, 1, 3]:  # include common event IDs; engine may map Sysmon differently
        # Some pipelines report event_id 7 for image load, or may use other ids â€” we're permissive here
        if 'spoolsv.exe' in (event.get('target_process') or event.get('process_name') or "").lower():
            if loaded_module and loaded_module.endswith('.dll'):
                # Optionally ignore known/trusted module paths (tweak ALLOWED_MODULE_PATHS as needed)
                ALLOWED_MODULE_PATHS = [
                    # example trusted DLL directories or filenames; customize for your environment
                    '\\windows\\system32\\spool\\drivers',
                    '\\windows\\system32\\spool\\drivers\\x64',
                ]
                allow = False
                for p in ALLOWED_MODULE_PATHS:
                    if p in loaded_module:
                        allow = True
                        break
                if not allow:
                    return 1.0

    # 2) Abnormal spoolsv.exe child process spawn (Sysmon ProcessCreate event_id 1)
    if evt == 1 or evt == 4688 or evt == 592 or evt == 4689:
        # ParentImage indicates the creator; image indicates the created child
        child_image = image or (event.get('command_line') or "").lower()
        parent = parent_image or (event.get('parent') or "").lower()

        # If spoolsv.exe is the parent and child is a suspicious binary -> alert
        if 'spoolsv.exe' in parent:
            # suspicious child executables that are uncommon as spooler children
            SUSPICIOUS_CHILDREN = ['cmd.exe', 'powershell.exe', 'powershell_ise.exe', 'rundll32.exe', 'wmic.exe', 'cscript.exe', 'wscript.exe', 'reg.exe', 'schtasks.exe', 'psexec.exe']
            for s in SUSPICIOUS_CHILDREN:
                if s in (child_image or ""):
                    return 1.0

            # also detect if child binary is in unusual locations (not system paths)
            if child_image and ('\\windows\\system32' not in child_image and '\\system32' not in child_image):
                # suspect: spoolsv spawns an executable from non-system path
                return 0.95

    # 3) Some pipelines record the target process in different fields; check for loaded_module targeted at spoolsv
    if loaded_module and spool_event:
        if loaded_module.endswith('.dll'):
            return 1.0

    return 0.0

def context(event_data):
    proc = (event_data.get('process_name') or event_data.get('image') or event_data.get('target_process') or "<unknown-process>")
    host = event_data.get('host') or event_data.get('computer') or "<unknown-host>"
    actor = event_data.get('account_name') or event_data.get('subject_account_name') or event_data.get('user') or "<unknown-user>"

    return "Potential Print Spooler exploitation activity detected: DLL load or abnormal child process involving spoolsv.exe on host %s (process: %s) by %s." % (host, proc, actor)

def criticality():
    return "CRITICAL"

def tactic():
    return "Privilege Escalation (TA0004)"

def technique():
    return "Exploitation for Privilege Escalation (T1068)"

def artifacts():
    return stats.collect([

        "event_id",
        "host",
        "process_name",
        "image",
        "parent_image",
        "loaded_module",
        "command_line",
        "account_name",
    ])

def entity(event):
    actor = event.get('source_account_name')
    return {"derived": False, "value": actor, "type": "accountname"}
